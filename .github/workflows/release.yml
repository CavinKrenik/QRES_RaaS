name: Release Pipeline

on:
  push:
    tags:
      - 'v*'
    paths-ignore:
      - '.zenodo.json'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build and release (e.g., v19.0.0)'
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel releases

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  TAG_NAME: ${{ github.event.inputs.tag || github.ref_name }}

jobs:
  build_wheels:
    name: Build Wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false  # Don't cancel other OS builds if one fails
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev pkg-config libudev-dev
      
      - name: Build Wheels (Maturin)
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/python
          command: build
          args: --release --out dist
          sccache: 'true'
          # Ensure SIMD is enabled if using specific features
          # env:
          #   RUSTFLAGS: "-C target-cpu=native" 
      
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: bindings/python/dist

  build_cli:
    name: Build CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}
      
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev pkg-config libudev-dev
      
      - name: Build Binary
        # Explicitly build the Daemon bin
        run: cargo build --release --bin qres_daemon
      
      - name: Package Artifacts
        shell: bash
        run: |
          mkdir -p bin
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp target/release/qres_daemon.exe bin/qres-daemon-windows.exe
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            cp target/release/qres_daemon bin/qres-daemon-macos
          else
            cp target/release/qres_daemon bin/qres-daemon-linux
          fi
      
      - uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.os }}
          path: bin/*
  
  build_wasm:
    name: Build WASM Core
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Build WASM
        working-directory: ./crates/qres_wasm
        run: wasm-pack build --target web --release
      
      - name: Compress WASM Package
        run: tar -czvf qres-wasm.tar.gz -C crates/qres_wasm/pkg .
      
      - uses: actions/upload-artifact@v4
        with:
          name: wasm-pkg
          path: qres-wasm.tar.gz

  release:
    name: Publish Release
    needs: [build_wheels, build_cli, build_wasm]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - uses: actions/download-artifact@v4
        with:
          pattern: cli-*
          path: dist
          merge-multiple: true
      - uses: actions/download-artifact@v4
        with:
          name: wasm-pkg
          path: dist
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: QRES ${{ env.TAG_NAME }}
          body_path: docs/releases/RELEASE_NOTES.md
          files: dist/*
          generate_release_notes: true
          draft: false  # Explicit - ensures Zenodo webhook fires immediately
